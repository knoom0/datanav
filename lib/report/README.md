# Report Module

This module handles storage and retrieval of report bundles generated by pulse jobs.

## Overview

The report module provides a centralized way to manage report bundles that are created by the AI agent during pulse job execution. Reports can include:
- Markdown text with structured content
- Data query results with records
- Chart configurations and visualizations

## Components

### ReportStore

The `ReportStore` class provides methods for managing report bundles in the database.

#### Creating a Report Bundle

```typescript
import { ReportStore } from "@/lib/report";
import { getUserDataSource } from "@/lib/entities";

const dataSource = await getUserDataSource();
const reportStore = new ReportStore({ dataSource });

const reportBundleId = await reportStore.create({
  pulseJobId: "job-123",
  bundle: {
    text: "# My Report\n\nReport content here...",
    dataQueryResults: [
      {
        name: "sales_data",
        description: "Monthly sales data",
        query: "SELECT month, revenue FROM sales",
        records: [
          { month: "Jan", revenue: 10000 },
          { month: "Feb", revenue: 12000 }
        ]
      }
    ]
  }
});
```

#### Retrieving a Report Bundle

```typescript
const reportBundle = await reportStore.get({ id: reportBundleId });

if (reportBundle) {
  console.log(reportBundle.bundle.text);
  console.log(reportBundle.bundle.dataQueryResults);
}
```

#### Getting Reports by Pulse Job

```typescript
const reports = await reportStore.getByJob({ pulseJobId: "job-123" });
console.log(`Found ${reports.length} reports for this job`);
```

#### Deleting a Report Bundle

```typescript
const deleted = await reportStore.delete({ id: reportBundleId });
if (deleted) {
  console.log("Report deleted successfully");
}
```

#### Converting to ReportBundle Artifact

```typescript
const entity = await reportStore.get({ id: reportBundleId });
const artifact = ReportStore.toReportBundle(entity);
// artifact is now in the ReportBundle format used by the agent
```

## API Endpoints

### GET /api/report/[id]

Fetches a specific report bundle by ID.

**Response:**
```json
{
  "id": "uuid",
  "pulseJobId": "job-id",
  "bundle": {
    "text": "# Report...",
    "dataQueryResults": [...]
  },
  "createdAt": "2025-10-24T12:00:00Z"
}
```

## Pages

### /report/[reportBundleId]

A page that renders a report bundle using the `ReportRenderer` component. Features:
- Back button for navigation
- Loading state
- Error handling
- Full report rendering with charts and visualizations

## Types

### CreateReportBundleParams

```typescript
{
  pulseJobId: string;
  bundle: {
    text: string;
    dataQueryResults: Array<{
      name: string;
      description: string;
      query: string;
      records: Record<string, any>[];
    }>;
  };
}
```

### GetReportBundleParams

```typescript
{
  id: string;
}
```

### GetReportBundlesByJobParams

```typescript
{
  pulseJobId: string;
}
```

## Testing

Tests are provided in `store.test.ts`. Run them with:

```bash
npm test lib/report/store.test.ts
```

## Integration with Pulse Jobs

Report bundles are automatically created during pulse job execution when the AI agent generates a report. The `PulseJobScheduler` uses the `ReportStore` to persist reports and returns the `reportBundleId` which is:
1. Stored in the pulse job output
2. Included in email notifications with a link to view the full report
3. Available for retrieval through the API or directly from the database

## Email Integration

When a pulse job completes successfully and a report bundle is generated:
1. The first markdown section of the report is extracted
2. It's converted to HTML using remark
3. An email is sent with the summary and a link to `/report/[reportBundleId]`

